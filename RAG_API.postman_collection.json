{
  "info": {
    "_postman_id": "rag-system-api-v2",
    "name": "RAG System API - Complete",
    "description": "Collection completa para o sistema RAG (Retrieval-Augmented Generation)\n\n## üîê Autentica√ß√£o\n\nA API suporta autentica√ß√£o JWT opcional. Para usar:\n1. Fa√ßa login em `/api/auth/login` para obter um token\n2. Use o token no header `Authorization: Bearer <token>`\n3. A autentica√ß√£o √© opcional - endpoints funcionam sem token (compatibilidade)\n\n## üìã Endpoints Dispon√≠veis\n\n### Autentica√ß√£o\n- `POST /api/auth/login` - Gerar token JWT\n- `POST /api/auth/verify` - Verificar token\n\n### Documentos\n- `POST /api/documents/upload` - Upload e processar documento\n- `POST /api/query` - Query com ou sem arquivo\n\n### Sistema\n- `GET /api/health` - Health check\n- `GET /api/collection/info` - Informa√ß√µes da cole√ß√£o\n- `DELETE /api/collection` - Limpar cole√ß√£o\n- `POST /api/circuit-breaker/reset` - Resetar Circuit Breaker\n- `GET /metrics` - M√©tricas Prometheus\n\n## üîí Permiss√µes (RBAC)\n\nSe autenticado, as seguintes permiss√µes s√£o verificadas:\n- **admin**: Acesso total\n- **premium**: Upload, query, delete\n- **user**: Upload, query\n- **guest**: Query apenas\n\n## ‚ö° Rate Limiting\n\n- Limite padr√£o: 100 requisi√ß√µes por 15 minutos\n- Headers de resposta: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "version": "2.0.0"
  },
  "item": [
    {
      "name": "üîê Autentica√ß√£o",
      "item": [
        {
          "name": "Login - Gerar Token JWT",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    if (response.token) {",
                  "        pm.collectionVariables.set('auth_token', response.token);",
                  "        pm.collectionVariables.set('user_id', response.user.userId);",
                  "        pm.collectionVariables.set('user_role', response.user.role);",
                  "        console.log('‚úÖ Token salvo automaticamente!');",
                  "    }",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"userId\": \"user123\",\n  \"role\": \"premium\",\n  \"email\": \"user@example.com\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{base_url}}/api/auth/login",
              "host": ["{{base_url}}"],
              "path": ["api", "auth", "login"]
            },
            "description": "Gera um token JWT para autentica√ß√£o.\n\n**Body:**\n```json\n{\n  \"userId\": \"string (obrigat√≥rio)\",\n  \"role\": \"user | premium | admin | guest (opcional, padr√£o: user)\",\n  \"email\": \"string (opcional)\"\n}\n```\n\n**Resposta:**\n```json\n{\n  \"success\": true,\n  \"token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\",\n  \"expiresIn\": 3600,\n  \"user\": {\n    \"userId\": \"user123\",\n    \"role\": \"premium\",\n    \"email\": \"user@example.com\"\n  }\n}\n```\n\n**Nota:** O token √© salvo automaticamente na vari√°vel `auth_token` ap√≥s login bem-sucedido."
          },
          "response": []
        },
        {
          "name": "Verify - Verificar Token",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"token\": \"{{auth_token}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{base_url}}/api/auth/verify",
              "host": ["{{base_url}}"],
              "path": ["api", "auth", "verify"]
            },
            "description": "Verifica se um token JWT √© v√°lido.\n\n**Body:**\n```json\n{\n  \"token\": \"string (obrigat√≥rio)\"\n}\n```\n\n**Resposta (v√°lido):**\n```json\n{\n  \"valid\": true,\n  \"user\": {\n    \"userId\": \"user123\",\n    \"role\": \"premium\",\n    \"email\": \"user@example.com\"\n  }\n}\n```\n\n**Resposta (inv√°lido):**\n```json\n{\n  \"valid\": false,\n  \"error\": \"Token expirado\"\n}\n```"
          },
          "response": []
        }
      ],
      "description": "Endpoints de autentica√ß√£o JWT"
    },
    {
      "name": "üìÑ Documentos",
      "item": [
        {
          "name": "Upload Documento",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}",
                "type": "text",
                "description": "Token JWT (opcional - autentica√ß√£o n√£o √© obrigat√≥ria)"
              }
            ],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "file",
                  "type": "file",
                  "src": [],
                  "description": "Arquivo PDF, DOCX, TXT ou HTML para processar e indexar"
                }
              ],
              "options": {
                "formdata": {}
              }
            },
            "url": {
              "raw": "{{base_url}}/api/documents/upload",
              "host": ["{{base_url}}"],
              "path": ["api", "documents", "upload"]
            },
            "description": "Faz upload e processa um documento separadamente (sem fazer query).\n\n**Form Data:**\n- `file` (obrigat√≥rio): Arquivo PDF, DOCX, TXT ou HTML\n\n**Resposta:**\n```json\n{\n  \"success\": true,\n  \"sessionId\": \"uuid\",\n  \"filename\": \"documento.pdf\",\n  \"chunksCreated\": 10,\n  \"metadata\": {\n    \"extension\": \".pdf\",\n    \"pages\": 5\n  }\n}\n```\n\n**Permiss√µes:**\n- Se autenticado: requer permiss√£o `document:upload`\n- Sem autentica√ß√£o: funciona normalmente (compatibilidade)\n\n**Use este endpoint quando:**\n- Quer indexar m√∫ltiplos documentos antes de fazer queries\n- Quer apenas adicionar documentos ao banco de dados\n- N√£o precisa fazer query imediatamente"
          },
          "response": []
        },
        {
          "name": "Query - Upload + Pergunta (Tudo em Um)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}",
                "type": "text",
                "description": "Token JWT (opcional)"
              }
            ],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "file",
                  "type": "file",
                  "src": [],
                  "description": "Arquivo PDF, DOCX, TXT ou HTML (opcional - pode fazer query sem upload)"
                },
                {
                  "key": "query",
                  "value": "Qual √© o conte√∫do do documento?",
                  "type": "text",
                  "description": "Sua pergunta sobre o documento (obrigat√≥rio)"
                }
              ],
              "options": {
                "formdata": {}
              }
            },
            "url": {
              "raw": "{{base_url}}/api/query",
              "host": ["{{base_url}}"],
              "path": ["api", "query"]
            },
            "description": "‚≠ê **ENDPOINT PRINCIPAL**: Faz upload de documento (opcional) + pergunta em uma √∫nica chamada.\n\n**Form Data:**\n- `file` (opcional): Arquivo PDF, DOCX, TXT ou HTML\n- `query` (obrigat√≥rio): Pergunta sobre o documento\n\n**Resposta (com arquivo):**\n```json\n{\n  \"success\": true,\n  \"response\": \"Resposta gerada pelo LLM...\",\n  \"sources\": [\"documento.pdf\"],\n  \"metadata\": {\n    \"model\": \"llama3.2\",\n    \"numSources\": 1\n  },\n  \"fileProcessed\": \"documento.pdf\"\n}\n```\n\n**Resposta (sem arquivo):**\n```json\n{\n  \"success\": true,\n  \"response\": \"Resposta usando conhecimento do modelo...\",\n  \"sources\": [],\n  \"metadata\": {\n    \"model\": \"llama3.2\",\n    \"numSources\": 0\n  },\n  \"fileProcessed\": null\n}\n```\n\n**Permiss√µes:**\n- Se autenticado: requer permiss√£o `query:create`\n- Sem autentica√ß√£o: funciona normalmente\n\n**‚úÖ CONFIGURA√á√ÉO CORRETA:**\n- Body deve estar em 'form-data' (N√ÉO raw)\n- Campo 'file': tipo File (selecionar arquivo)\n- Campo 'query': tipo Text (digitar pergunta)\n- N√ÉO definir Content-Type manualmente (Postman faz automaticamente)"
          },
          "response": []
        },
        {
          "name": "Query - Apenas Pergunta (JSON)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}",
                "type": "text",
                "description": "Token JWT (opcional)"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"query\": \"Qual √© o conte√∫do do documento?\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{base_url}}/api/query",
              "host": ["{{base_url}}"],
              "path": ["api", "query"]
            },
            "description": "Faz uma pergunta sobre documentos j√° indexados usando formato JSON (sem fazer upload de arquivo).\n\n**Body (JSON):**\n```json\n{\n  \"query\": \"string (obrigat√≥rio)\"\n}\n```\n\n**Resposta:**\n```json\n{\n  \"success\": true,\n  \"response\": \"Resposta usando conhecimento do modelo...\",\n  \"sources\": [],\n  \"metadata\": {\n    \"model\": \"llama3.2\",\n    \"numSources\": 0\n  },\n  \"fileProcessed\": null\n}\n```\n\n**Permiss√µes:**\n- Se autenticado: requer permiss√£o `query:create`\n- Sem autentica√ß√£o: funciona normalmente\n\n**Use este endpoint quando:**\n- J√° fez upload de documentos anteriormente\n- Quer fazer m√∫ltiplas perguntas sobre os mesmos documentos\n- N√£o precisa enviar arquivo"
          },
          "response": []
        },
        {
          "name": "Query - Apenas Pergunta (Form-Data)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}",
                "type": "text",
                "description": "Token JWT (opcional)"
              }
            ],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "query",
                  "value": "Qual √© o conte√∫do do documento?",
                  "type": "text",
                  "description": "Sua pergunta sobre documentos j√° indexados"
                }
              ],
              "options": {
                "formdata": {}
              }
            },
            "url": {
              "raw": "{{base_url}}/api/query",
              "host": ["{{base_url}}"],
              "path": ["api", "query"]
            },
            "description": "Faz uma pergunta sobre documentos j√° indexados usando form-data (sem fazer upload de arquivo).\n\n**Form Data:**\n- `query` (obrigat√≥rio): Pergunta sobre documentos indexados\n\n**Permiss√µes:**\n- Se autenticado: requer permiss√£o `query:create`\n- Sem autentica√ß√£o: funciona normalmente\n\n**Use este endpoint quando:**\n- J√° fez upload de documentos anteriormente\n- Prefere usar form-data ao inv√©s de JSON"
          },
          "response": []
        }
      ],
      "description": "Endpoints para gerenciamento de documentos e queries"
    },
    {
      "name": "üîß Sistema",
      "item": [
        {
          "name": "Health Check",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/health",
              "host": ["{{base_url}}"],
              "path": ["api", "health"]
            },
            "description": "Verifica a sa√∫de do sistema e suas depend√™ncias.\n\n**Resposta:**\n```json\n{\n  \"status\": \"ok\",\n  \"timestamp\": \"2024-12-08T15:00:00.000Z\",\n  \"uptime\": 3600,\n  \"dependencies\": {\n    \"ollama\": { \"status\": \"ok\" },\n    \"vectorDb\": { \"status\": \"ok\" },\n    \"redis\": { \"status\": \"ok\", \"message\": \"Redis desabilitado (usando mem√≥ria)\" },\n    \"circuitBreaker\": {\n      \"state\": \"CLOSED\",\n      \"stats\": {\n        \"failures\": 0,\n        \"successes\": 10,\n        \"lastFailureTime\": null,\n        \"state\": \"CLOSED\"\n      }\n    }\n  },\n  \"memory\": {\n    \"rss\": 123456789,\n    \"heapTotal\": 123456789,\n    \"heapUsed\": 123456789,\n    \"external\": 123456789\n  }\n}\n```\n\n**Status Codes:**\n- `200`: Todos os servi√ßos est√£o saud√°veis\n- `503`: Algum servi√ßo est√° com problema"
          },
          "response": []
        },
        {
          "name": "M√©tricas Prometheus",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/metrics",
              "host": ["{{base_url}}"],
              "path": ["metrics"]
            },
            "description": "Retorna m√©tricas no formato Prometheus.\n\n**Resposta:**\n```\n# HELP http_requests_total Total de requisi√ß√µes HTTP\n# TYPE http_requests_total counter\nhttp_requests_total{method=\"GET\",route=\"/api/health\",status=\"200\"} 10\n\n# HELP http_request_duration_seconds Dura√ß√£o das requisi√ß√µes HTTP\n# TYPE http_request_duration_seconds histogram\nhttp_request_duration_seconds_bucket{method=\"GET\",route=\"/api/health\",status=\"200\",le=\"0.1\"} 8\n...\n```\n\n**Use para:**\n- Monitoramento com Prometheus\n- Grafana dashboards\n- Alertas"
          },
          "response": []
        },
        {
          "name": "Info da Cole√ß√£o",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/collection/info",
              "host": ["{{base_url}}"],
              "path": ["api", "collection", "info"]
            },
            "description": "Retorna informa√ß√µes sobre as sess√µes e cole√ß√µes.\n\n**Resposta:**\n```json\n{\n  \"message\": \"Cole√ß√µes agora s√£o isoladas por sess√£o. Cada requisi√ß√£o cria sua pr√≥pria cole√ß√£o.\",\n  \"stats\": {\n    \"totalSessions\": 10,\n    \"oldSessions\": 5,\n    \"totalSizeMB\": \"2.45\",\n    \"oldSessionsSizeMB\": \"1.20\"\n  },\n  \"note\": \"Sess√µes antigas s√£o limpas automaticamente.\"\n}\n```\n\n**Nota:** Cada requisi√ß√£o cria sua pr√≥pria sess√£o isolada. Use o `sessionId` retornado nas respostas para identificar cole√ß√µes espec√≠ficas."
          },
          "response": []
        },
        {
          "name": "Limpar Cole√ß√£o",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}",
                "type": "text",
                "description": "Token JWT (opcional, mas requer permiss√£o se autenticado)"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/collection",
              "host": ["{{base_url}}"],
              "path": ["api", "collection"]
            },
            "description": "Limpa manualmente todas as sess√µes expiradas.\n\n**Resposta:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Limpeza manual executada.\",\n  \"stats\": {\n    \"sessionsChecked\": 10,\n    \"sessionsDeleted\": 5,\n    \"sizeFreedMB\": \"2.45\",\n    \"errors\": []\n  }\n}\n```\n\n**Permiss√µes:**\n- Se autenticado: requer permiss√£o `collection:delete` (admin ou premium)\n- Sem autentica√ß√£o: funciona normalmente\n\n**‚ö†Ô∏è ATEN√á√ÉO:** Esta a√ß√£o remove sess√µes expiradas. Sess√µes ativas n√£o s√£o afetadas."
          },
          "response": []
        },
        {
          "name": "Reset Circuit Breaker",
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/circuit-breaker/reset",
              "host": ["{{base_url}}"],
              "path": ["api", "circuit-breaker", "reset"]
            },
            "description": "Reseta o Circuit Breaker manualmente (√∫til quando est√° aberto).\n\n**Resposta:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Circuit Breaker resetado com sucesso\",\n  \"state\": \"CLOSED\"\n}\n```\n\n**Use quando:**\n- Circuit Breaker est√° aberto (bloqueando requisi√ß√µes)\n- Servi√ßo externo (Ollama) foi recuperado\n- Quer for√ßar reset manual"
          },
          "response": []
        }
      ],
      "description": "Endpoints de sistema e monitoramento"
    }
  ],
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:3000",
      "type": "string",
      "description": "URL base da API. Altere se o servidor estiver rodando em outra porta ou host."
    },
    {
      "key": "auth_token",
      "value": "",
      "type": "string",
      "description": "Token JWT gerado automaticamente ap√≥s login. Use no header Authorization: Bearer {{auth_token}}"
    },
    {
      "key": "user_id",
      "value": "",
      "type": "string",
      "description": "ID do usu√°rio autenticado (preenchido automaticamente ap√≥s login)"
    },
    {
      "key": "user_role",
      "value": "",
      "type": "string",
      "description": "Role do usu√°rio autenticado (preenchido automaticamente ap√≥s login)"
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Garantir que n√£o h√° Content-Type manual para form-data",
          "if (pm.request.body && pm.request.body.mode === 'formdata') {",
          "    pm.request.headers.remove('Content-Type');",
          "}",
          "",
          "// Log de requisi√ß√£o (opcional - descomente para debug)",
          "// console.log('Request:', pm.request.method, pm.request.url.toString());"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Verificar rate limiting",
          "if (pm.response.headers.has('X-RateLimit-Remaining')) {",
          "    const remaining = pm.response.headers.get('X-RateLimit-Remaining');",
          "    const limit = pm.response.headers.get('X-RateLimit-Limit');",
          "    const reset = pm.response.headers.get('X-RateLimit-Reset');",
          "    console.log(`Rate Limit: ${remaining}/${limit} (reset em ${new Date(reset * 1000).toLocaleTimeString()})`);",
          "}",
          "",
          "// Verificar autentica√ß√£o",
          "if (pm.response.code === 401) {",
          "    console.warn('‚ö†Ô∏è Token inv√°lido ou expirado. Fa√ßa login novamente.');",
          "    pm.collectionVariables.set('auth_token', '');",
          "}",
          "",
          "// Verificar permiss√µes",
          "if (pm.response.code === 403) {",
          "    console.warn('‚ö†Ô∏è Acesso negado. Verifique suas permiss√µes.');",
          "}"
        ]
      }
    }
  ]
}
